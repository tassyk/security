---
Title: Malware analysis distro
Type: Doc
Nature: Notes
Création: 06/09/2021
---

# Malware analysis distro
---
**Sommaire**

- **[Introduction](#Introduction)**
- **[Mise en place](#Mise-en-place)**
  - [Flare VM](#Flare-VM)
  - [Parrot OS](#Parrot-OS)
- **[Autres distro](#Autres-distro)**
  - [Kali Linux](#Kali-Linux)
  - [Parrot OS](#Parrot-OS)
- **[Liens](#Liens)**
---

## Introduction
Dans cette note, nous allons voir comment mettre en place quelques distributions dédiées à l'analyse de malware (Forensique de manière générale). Il s'agit de :
- [FlareVM](https://github.com/fireeye/flare-vm),
- [REMnux](https://remnux.org/)

> Attention : Après avoir mis en place une telle plate-forme, il faut bien l'isoler (couper toute connectivité réseau) avant de commencer toute opération d'analyse. Aussi prendre des snapshots, pour pouvoir revenir à un état donné à tout moment.

## Mise en place
### Flare VM
[FlareVM](https://github.com/fireeye/flare-vm) est une plate-forme open source, dédiée à l'analyse de malware (forensique) sous Windows.  Il s'inspire d'autres distributions comme Kali existant pour Linux. 
> Prerequis VM : 60 GB Hard Drive / 2 GB RAM

On peut disposer d'une machine Windows de plusieurs manières :
- Windows 10 with Microsoft Edge (MSEDGE): https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/
- Windows 10 development environment: https://developer.microsoft.com/fr-fr/windows/downloads/virtual-machines/
- Windows 10 Vagrant Box : https://app.vagrantup.com/gusztavvargadr/boxes/windows-10
    ```
    vagrant init gusztavvargadr/windows-10
    vagrant up

    ```
> Remarque : Pour MSEDGE, la machine est disponible pendant 90 jours. Donc, il faut faire un snapshot pour revenir en arrière à tout moment.

Après avoir mis en place la VM (via Vagrant pour nous), nous pouvons procéder à l'[installation](https://www.fireeye.com/blog/threat-research/2018/11/flare-vm-update.html). Pour cela :

1. sur la machine, cloner ou télécharger le [repos Github](https://github.com/fireeye/flare-vm)
2. Lancer une session powershel en tant que admin
3. Aller dans l'emplacement où le repo flare vm a été décompressé (ou cloné 
3. Activer 'unrestricted execution policy pour PowerShell' en exécutant : `Set-ExecutionPolicy unrestricted`
> Note : Taper `O ou Y` pour autoriser l'action

4. Exécute ensuite le script d'installation, `install.ps1`
    ```
    .\install.ps1 [-password <current_user_password>]
    ``` 
> Note : Le mot de passe de l'utilisateur courrent sera demandé (si non spécifié en ligne de commande). Laissez l'installation se dérouler. Cliquer de temps en temps sur la touche ENTRER du clavier pour faire avancer l'installation.

> Remarque :  On peut installer un nouvel outil sur Flare VM via Chocolate : ``cinst ou choco install``. Pour mettre à jour tous les paquets : `cup all`


### REMnux
[REMnux](https://remnux.org/) est une collection d'outils Linux pour l'analyse de malwares, reverse ingeneering, et de forensique. A différence de Flare VM, il peut être installer de différentes manières :
- A partir d'une appliance virtuelle (OVA) : https://docs.remnux.org/install-distro/get-virtual-appliance
> Note : Username: remnux et password : malware

- Install from Scratch : https://docs.remnux.org/install-distro/install-from-scratch
- Installation sur une machine existante : https://docs.remnux.org/install-distro/add-to-existing-system
- Exéctuter REMnux en tant que containeur : https://docs.remnux.org/install-distro/remnux-as-a-container

Nous choisirons la troisième option d'installation (from scratch). Et pour cela, nous allons d'abord installer une VM Ubuntu 20.04 (sur VirtualBox)
> C'est disponible via : 
> - une ISO : https://doc.ubuntu-fr.org/versions
> - ou ubuntu-20.04. Vagrant Box : https://app.vagrantup.com/bento/boxes/ubuntu-20.04.<br>

```
vagrant init peru/ubuntu-20.04-desktop-amd64 --box-version 20210901.01
vagrant up
```

> Note : recommandation  4 GB RAM et 60 GB disk. Donc adapter vagrantfile en conséquence.
> remarque : Ce box n'est pas forcément le mieux, recherche un box mieux noté dans Vagrant Cloud ou via la commande `vagrant search ubuntu`.

Dès que la VM est correctement mise en place, nous pouvons procéder comme suit pour l'installation :
1. Mettre à jour les paquets : ` sudo apt update -y`
2. Télcharger l'installeur : `wget https://REMnux.org/remnux-cli`
> Note : Nous pouvons vérifier le hash pour s'assurer que ce n'est altéré : `sha256sum remnux-cli` 

3. Paramétrer l'installeur en exécutant ces commandes :
```
mv remnux-cli remnux
chmod +x remnux
sudo mv remnux /usr/local/bin
```
4. Installer GnuPGP (s'il n'existe pas sur la machine) : `sudo apt install -y gnupg`
5. Lancer l'installation : `sudo remnux install`
> Note : Si l'on souhaite accéder à la machine à distante (environnement distant), utiliser `sudo remnux install --mode=cloud`
> Laisser l'installation se poursuivre jusqu'au bout. 
> A la fin de l'installation, s'il y a une error, vérifier le fichier `/var/cache/remnux/cli/saltstack.log`, sinon rebooter la VM : `sudo reboot`.
> Si les outils n'apparaissent pas dans le bureau, alors vérifier le répertoire `/opt` ou taper le nom d'un outil dans le terminal (ex : `peepdf, procdot, ...` )
> Changer la [disposition du clavier](https://docs.remnux.org/tips/remnux-config-tips#keyboard-layout-change) si nécessaire, ou taper simplement `setxkbmap fr` dans un terminal.

> Remarque : Pour les mises à jour, utiliser `remnux update ou remnux upgrade` (utilisateur non-root). S'il il y a un problème, tenter ceci :
```
sudo apt update
sudo apt autoremove
sudo apt --fix-broken install
```
> Voir la documentation pour plus de détails.

## Autres distro
D'autres distributions comme [Kali Linux](https://www.kali.org/get-kali/) ou [Parrot OS](https://parrotsec.org/) peuvent aussi être utilisés pour l'analyse de malware. Ce sont des distributions très complètes pouvant être utilisées pour l'analyse de malware, le forensique, le pentest (test d'intrusion), ...

### Kali Linux
On peut disposer de [Kali Linux](https://www.kali.org/get-kali/) de plusisuers manières : Appliance virtuelle, Bare metal (ISO), Container, WSL (Windows Subsystem for Linux), Vagrant ...
Pour ce souci de simplicité, je l'installe via Vagrant :
```
vagrant init kalilinux/rolling
vagrant up
```
> Note : Appliance virtuelle et ISO sont recommandés.


### Parrot OS
A l'image de Kali, [Parrot OS](https://parrotsec.org/) est aussi une distribution complète. Il dispose des outils nécessaires pour le Pentest, le Forensique, l'analyse de malware, ... Il est disponilble en [différentes édition](https://parrotsec.org/download/) (Home, Security, Cloud) sous Appliance virtuelle, Docker.

Choisissez la version qui vous convient. Pour l'installation, voir la [documentation](https://parrotsec.org/docs/installation.html).

## Conclusion
Nous avons vu comment installer quelques distributions pour réanaliser l'analyse de malware sous Windows mais aussi Linux. Chaque distribution offre en général plusieurs méthodes d'installation.
Pour notre part, nous avons opté , nous avons opté pour Vagrant l'installation des VM quand cela est possible (windows 10, Ubuntu, Kali).
Pour aller plus loin, regarder les liens ci-dessous.

## Liens
- [FlareVM](https://github.com/fireeye/flare-vm)
- [REMnux](https://remnux.org/)
- [Kali Linux](https://www.kali.org/get-kali/) 
- [Parrot OS](https://parrotsec.org/)
- [REMnux Tool Tips](https://docs.remnux.org/tips/remnux-tool-tips)
- [REMnux Usage Tips for Malware Analysis on Linux](https://zeltser.com/remnux-malware-analysis-tips/)
- [Remnux cheat sheet](https://zeltser.com/media/docs/remnux-malware-analysis-tips.pdf)
